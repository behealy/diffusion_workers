openapi: 3.0.3
info:
  title: Mooove Diffusion API
  description: |
    Generative Diffusion Generation API .
    
    This API provides image generation capabilities using Stable Diffusion XL (SDXL) models with support for:
    - Text-to-Image generation
    - Image-to-Image generation  
    - Inpainting
    - ControlNet Union with 8 control modes
    - LoRA adapters for fine-tuned models
    - Multiple schedulers and configurations
    
    The service runs on GPU-enabled infrastructure and returns high-quality generated images based on text prompts and optional control inputs.
  version: 1.0.0
  contact:
    name: SDXL Worker Support
  license:
    name: MIT
servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.runpod.ai/v2/{endpoint_id}
    description: RunPod serverless endpoint
    variables:
      endpoint_id:
        description: Your RunPod endpoint ID
        default: your-endpoint-id

paths:
  /generate-sync:
    post:
      summary: Generate image synchronously
      description: |
        Generate an image from a text prompt with optional control inputs.
        
        Supports multiple generation modes:
        - **Text-to-Image**: Generate from prompt only
        - **Image-to-Image**: Transform an existing image
        - **Inpainting**: Fill masked areas of an image
        - **ControlNet**: Use control images to guide generation
        - **LoRA**: Apply fine-tuned model adapters
      operationId: generateImage
      tags:
        - Image Generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImageGenerateRequest'
            examples:
              text_to_image:
                summary: Simple text-to-image generation
                value:
                  input:
                    prompt: "A beautiful landscape with mountains and lakes, highly detailed"
                    negative_prompt: "blurry, low quality"
                    dimensions: [1024, 1024]
                    inference_steps: 50
                    guidance_scale: 7.5
                    seed: 42
              controlnet_generation:
                summary: ControlNet-guided generation
                value:
                  input:
                    prompt: "A cyberpunk city street scene, neon lights"
                    dimensions: [1024, 1024]
                    controlnets:
                      - guide_image: "data:image/jpeg;base64,/9j/4AAQSkZJRgABA..."
                        union_control_mode: 3
                        controlnet_conditioning_scale: 1.0
              lora_generation:
                summary: Generation with LoRA adapter
                value:
                  input:
                    prompt: "A portrait in anime style"
                    dimensions: [1024, 1024]
                    loras:
                      - model: "author/anime-lora"
                        weight_name: "anime.safetensors"
                        scale: 0.8
                        tag: "anime style"
      responses:
        '200':
          description: Image generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageGenerationResponse'
              examples:
                success:
                  summary: Successful generation
                  value:
                    image: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                    prompt: "A beautiful landscape with mountains and lakes, highly detailed"
                    seed: 42
                    warnings: []
                local_debug:
                  summary: Local debug mode response
                  value:
                    status: "success"
                    image: "output_20241201_143022.png"
                    prompt: "A beautiful landscape with mountains and lakes, highly detailed"
                    seed: 42
                    warnings: []
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /memory-info:
    get:
      summary: Get memory information
      description: Returns current GPU and system memory usage information
      operationId: getMemoryInfo
      tags:
        - System
      responses:
        '200':
          description: Memory information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MemoryInfoResponse'
              example:
                info:
                  gpu_memory_used: "4.2 GB"
                  gpu_memory_total: "24.0 GB"
                  system_memory_used: "8.1 GB"
                  system_memory_total: "32.0 GB"

components:
  schemas:
    ImageGenerateRequest:
      type: object
      required:
        - input
      properties:
        input:
          $ref: '#/components/schemas/ImageGenerationParams'
      description: Request payload for image generation

    ImageGenerationParams:
      type: object
      required:
        - prompt
        - dimensions
      properties:
        prompt:
          type: string
          description: Text prompt describing the desired image
          example: "A beautiful landscape with mountains and lakes, highly detailed"
          minLength: 1
        starting_image:
          type: string
          description: Base64 encoded starting image for image-to-image or inpainting
          nullable: true
        negative_prompt:
          type: string
          description: Negative prompt to avoid unwanted elements
          example: "blurry, low quality, distorted"
          nullable: true
        base_model:
          type: string
          description: HuggingFace model identifier to use for generation
          example: "stabilityai/stable-diffusion-xl-base-1.0"
          nullable: true
        guidance_scale:
          type: number
          format: float
          description: How closely to follow the prompt (higher = more faithful)
          minimum: 0.0
          maximum: 20.0
          default: 7.5
          nullable: true
        inference_steps:
          type: integer
          description: Number of denoising steps (higher = more detailed but slower)
          minimum: 1
          maximum: 100
          default: 50
          nullable: true
        seed:
          type: integer
          description: Random seed for reproducible generation
          format: int64
          nullable: true
        dimensions:
          type: object
          required:
            - width
            - height
          properties:
            width:
              type: integer
              default: 512
            height: 
              type: integer
              default: 512
          default: {width: 512, height: 512}
          description: Output image dimensions {width, height}
        inpaint:
          $ref: '#/components/schemas/InpaintParams'
          nullable: true
        image_to_image:
          $ref: '#/components/schemas/ImageToImageParams'
          nullable: true
        controlnets:
          type: array
          description: List of ControlNet configurations
          items:
            $ref: '#/components/schemas/ControlNetParams'
          nullable: true
        loras:
          type: array
          description: List of LoRA adapter configurations
          items:
            $ref: '#/components/schemas/LoraParams'
          nullable: true
        pipeline_optimizations:
          type: object
          description: List of diffusion pipeline optimization configurations
          properties:
            use_deepcache:
              type: boolean
              default: false
              example: false
            deepcache_interval:
              type: integer
              default: 3
              example: 3
            deepcache_branch_id:
              type: integer
              default: 1
              example: 0
            use_torch_compile: 
              type: boolean
              default: false
              example: false
            
    ImageInput:
      type: object
      required:
        - source
      properties:
        source:
          type: string
          description: either url or base64 string
            
    ControlNetParams:
      type: object
      required:
        - guide_image
        - processor_type
      properties:
        guess_mode:
          type: boolean
          description: generates an image from only the control input (canny edge, depth map, pose, etc.) and without guidance from a prompt.
          default: false
        guide_image:
          type: string
          description: Control image 
          $ref: '#/components/schemas/ImageInput'
        needs_preprocess:
          type: boolean
          default: false
        model:
          type: string
          description: ControlNet model identifier
          nullable: true
        controlnet_conditioning_scale:
          type: number
          format: float
          description: Strength of ControlNet influence
          minimum: 0.0
          maximum: 2.0
          default: 1.0
        control_guidance_end:
          type: number
          format: float
          description: When to stop applying ControlNet guidance (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
          default: 1.0
        control_guidance_start:
          type: number
          format: float
          description: When to start applying ControlNet guidance (0.0-1.0)
          minimum: 0.0
          maximum: 1.0
          default: 0.0
        strength:
          type: number
          format: float
          description: Overall ControlNet strength
          minimum: 0.0
          maximum: 1.0
          default: 0.7
        processor_type: 
          $ref: '#/components/schemas/CNProcessorType'

    LoraParams:
      type: object
      required:
        - model
        - weight_name
      properties:
        model:
          type: string
          description: HuggingFace LoRA model identifier
          example: "author/anime-lora"
        weight_name:
          type: string
          description: Specific weight file name within the model
          example: "anime.safetensors"
        tag:
          type: string
          description: Optional trigger tag to append to prompt
          example: "anime style"
          nullable: true
        scale:
          type: number
          format: float
          description: LoRA scaling factor (can be single value or per-layer dict)
          default: 0.8

    InpaintParams:
      type: object
      required:
        - starting_image
        - mask_image
      properties:
        starting_image:
          $ref: '#/components/schemas/ImageInput'
          description: Starting image for inpaint  
        mask_image:
          $ref: '#/components/schemas/ImageInput'
          description: Mask image for inpaint (black = keep, white = inpaint)
        use_controlnet_union_inpaint:
          type: boolean
          description: Whether to use ControlNet Union inpainting mode
          default: false

    ImageToImageParams:
      type: object
      required:
        - starting_image
      properties:
        starting_image:
          $ref: '#/components/schemas/ImageInput'
          description: Starting image for image-to-image generation   

    CNProcessorType:
      type: string
      enum:
        - canny
        - depth_leres
        - depth_leres++
        - depth_midas
        - depth_zoe
        - lineart_anime
        - lineart_coarse
        - lineart_realistic
        - mediapipe_face
        - mlsd
        - normal_bae
        - openpose
        - openpose_face
        - openpose_faceonly
        - openpose_full
        - openpose_hand
        - scribble_hed
        - scribble_pidinet
        - shuffle
        - softedge_hed
        - softedge_hedsafe
        - softedge_pidinet
        - softedge_pidsafe
        - dwpose
        - openpose_hand_body
        - segmentation
        - inpaint
      description: ControlNet preprocessing method

    OpStatus:
      type: string
      enum:
        - PENDING
        - SUCCESS
        - FAILURE
      description: Operation status

    OpResult:
      type: object
      required:
        - operation
        - status
      properties:
        operation:
          type: string
          description: Name of the operation
        status:
          $ref: '#/components/schemas/OpStatus'
        message:
          type: string
          description: Optional status message
          nullable: true
        result:
          description: Optional operation result data
          nullable: true

    ImageGenerationResponse:
      type: object
      required:
        - prompt
        - seed
        - warnings
      properties:
        image:
          type: string
          description: Base64 encoded generated image (production mode)
          format: byte
        status:
          type: string
          description: Generation status (local debug mode)
          example: "success"
        prompt:
          type: string
          description: Final prompt used for generation (may include LoRA tags)
        seed:
          type: integer
          format: int64
          description: Seed used for generation
        warnings:
          type: array
          description: Any warnings or non-fatal errors during generation
          items:
            $ref: '#/components/schemas/OpResult'

    MemoryInfoResponse:
      type: object
      required:
        - info
      properties:
        info:
          type: object
          description: Memory usage information
          additionalProperties:
            type: string

    ValidationError:
      type: object
      properties:
        detail:
          type: array
          items:
            type: object
            properties:
              loc:
                type: array
                items:
                  oneOf:
                    - type: string
                    - type: integer
              msg:
                type: string
              type:
                type: string

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          description: Error message

  examples:
    SimpleTextToImage:
      summary: Basic text-to-image generation
      value:
        input:
          prompt: "A serene mountain landscape at sunset"
          dimensions: [1024, 1024]
          inference_steps: 30
          guidance_scale: 7.5

    ControlNetGeneration:
      summary: ControlNet-guided generation
      value:
        input:
          prompt: "A futuristic city skyline"
          dimensions: [1024, 1024]
          controlnets:
            - guide_image: "data:image/jpeg;base64,..."
              union_control_mode: 3
              controlnet_conditioning_scale: 0.8

    LoRAGeneration:
      summary: Generation with LoRA adapter
      value:
        input:
          prompt: "A portrait of a character"
          dimensions: [1024, 1024]
          loras:
            - model: "artist/style-lora"
              weight_name: "style.safetensors"
              scale: 0.7

tags:
  - name: Image Generation
    description: Image generation endpoints
  - name: System
    description: System information and health endpoints